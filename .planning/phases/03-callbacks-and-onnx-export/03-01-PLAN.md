---
phase: 03-callbacks-and-onnx-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pixi.toml
  - src/classifier_training/callbacks/__init__.py
  - src/classifier_training/callbacks/ema.py
  - src/classifier_training/callbacks/onnx_export.py
  - src/classifier_training/data/sampler.py
  - src/classifier_training/data/__init__.py
  - tests/test_callbacks_ema.py
  - tests/test_callbacks_onnx_export.py
autonomous: true

must_haves:
  truths:
    - "EMACallback maintains exponential moving average of model weights and swaps them in for validation"
    - "ONNXExportCallback exports model with EMA weights to ONNX format with output name 'logits' and dynamic batch axis"
    - "ONNX model loads and runs correctly under onnxruntime with CPUExecutionProvider"
    - "TrackingWeightedRandomSampler records sampled indices for SamplerDistributionCallback"
    - "Dependencies matplotlib, onnxscript, onnxruntime, pandas are installed in pixi environment"
  artifacts:
    - path: "src/classifier_training/callbacks/ema.py"
      provides: "EMACallback with configurable decay and warmup"
      contains: "class EMACallback"
    - path: "src/classifier_training/callbacks/onnx_export.py"
      provides: "ONNXExportCallback that exports from EMA state dict"
      contains: "class ONNXExportCallback"
    - path: "src/classifier_training/data/sampler.py"
      provides: "TrackingWeightedRandomSampler with _last_indices"
      contains: "class TrackingWeightedRandomSampler"
    - path: "tests/test_callbacks_ema.py"
      provides: "EMA state dict correctness tests"
    - path: "tests/test_callbacks_onnx_export.py"
      provides: "ONNX export and validation tests"
  key_links:
    - from: "src/classifier_training/callbacks/onnx_export.py"
      to: "src/classifier_training/callbacks/ema.py"
      via: "EMACallback.ema_state_dict lookup in trainer.callbacks"
      pattern: "isinstance.*EMACallback"
    - from: "src/classifier_training/data/sampler.py"
      to: "src/classifier_training/data/datamodule.py"
      via: "TrackingWeightedRandomSampler replaces WeightedRandomSampler in _build_sampler"
---

<objective>
Add new pixi dependencies (matplotlib, onnxscript, onnxruntime, pandas), implement EMACallback and ONNXExportCallback, create TrackingWeightedRandomSampler, and write unit tests for EMA and ONNX export.

Purpose: Establish the critical-path callbacks (EMA weight averaging and ONNX export) that form the backbone of the training-to-production pipeline, plus the dependency foundation all other callbacks need.
Output: Working EMA + ONNX export with tests; pixi environment with all Phase 3 deps; TrackingWeightedRandomSampler ready for SamplerDistributionCallback.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-callbacks-and-onnx-export/03-RESEARCH.md

# Sibling source files to port from (read these before implementing):
@/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/object-detection-training/src/object_detection_training/callbacks/ema.py
@/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/object-detection-training/src/object_detection_training/callbacks/onnx_export.py
@/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/object-detection-training/tests/test_callbacks_ema.py
@/Users/ortizeg/1Projects/⛹️‍♂️ Next Play/code/object-detection-training/tests/test_callbacks_onnx_export.py

# Existing classifier-training code to reference:
@src/classifier_training/types.py
@src/classifier_training/models/base.py
@src/classifier_training/data/datamodule.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 3 dependencies and create TrackingWeightedRandomSampler</name>
  <files>
    pixi.toml
    src/classifier_training/data/sampler.py
    src/classifier_training/data/__init__.py
  </files>
  <action>
1. Add dependencies to `pixi.toml`:
   - Under `[dependencies]`: add `matplotlib = "*"`, `onnxscript = ">=0.5.6,<0.6"`, `pandas = "*"`
   - Under `[pypi-dependencies]`: add `onnxruntime = ">=1.23.2, <2"`
   - Run `pixi install` to resolve and lock dependencies
   - Verify: `pixi run python -c "import onnx; import onnxruntime; import matplotlib; print('OK')"`

2. Create `src/classifier_training/data/sampler.py`:
   - Port `TrackingWeightedRandomSampler` from sibling pattern (see 03-RESEARCH.md Pattern 5)
   - Subclass `torch.utils.data.WeightedRandomSampler`
   - Override `__iter__` to capture `_last_indices: list[int]`
   - Type annotations: `from __future__ import annotations`, proper `Iterator[int]` return type

3. Update `src/classifier_training/data/__init__.py`:
   - Export `TrackingWeightedRandomSampler` alongside existing exports

4. Update `src/classifier_training/data/datamodule.py`:
   - Replace `WeightedRandomSampler` import with `TrackingWeightedRandomSampler` from `classifier_training.data.sampler`
   - Update `_build_sampler()` method to use `TrackingWeightedRandomSampler` instead of `WeightedRandomSampler`
   - Keep all existing parameters and behavior identical — only the class changes
  </action>
  <verify>
    `pixi run python -c "import onnx; import onnxruntime; import matplotlib; import pandas; print('OK')"` prints OK.
    `pixi run python -c "from classifier_training.data.sampler import TrackingWeightedRandomSampler; print('OK')"` prints OK.
    `pixi run pytest tests/test_datamodule.py -x` still passes (existing tests unbroken by sampler swap).
    `pixi run lint` and `pixi run typecheck` pass.
  </verify>
  <done>
    All Phase 3 dependencies installed. TrackingWeightedRandomSampler is used in ImageFolderDataModule. Existing datamodule tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement EMACallback and ONNXExportCallback with tests</name>
  <files>
    src/classifier_training/callbacks/__init__.py
    src/classifier_training/callbacks/ema.py
    src/classifier_training/callbacks/onnx_export.py
    tests/test_callbacks_ema.py
    tests/test_callbacks_onnx_export.py
  </files>
  <action>
1. Create `src/classifier_training/callbacks/__init__.py`:
   - Export `EMACallback` and `ONNXExportCallback` (other callbacks added in plan 03-02)
   - Keep minimal — just re-exports

2. Create `src/classifier_training/callbacks/ema.py` — port from sibling `ema.py`:
   - Class `EMACallback(L.Callback)` with `__init__(self, decay: float = 0.9999, warmup_steps: int = 2000)`
   - `ema_state_dict: dict[str, torch.Tensor]` attribute — publicly accessible for ONNXExportCallback
   - `_step_count: int` for warmup tracking
   - `on_train_batch_end`: update EMA state dict using exponential moving average with warmup ramp
   - `on_validation_start`: swap EMA weights into model (`_swap_in`)
   - `on_validation_end`: restore original weights (`_swap_out`)
   - `on_test_start` / `on_test_end`: same swap pattern as validation
   - Key adaptation from sibling: change `DetectionBatch` type annotation to `ClassificationBatch` in `on_train_batch_end` signature
   - Warmup formula: `min(decay, (1 + step_count) / (10 + step_count))` — matches sibling exactly

3. Create `src/classifier_training/callbacks/onnx_export.py` — adapted from sibling `onnx_export.py`:
   - Class `ONNXExportCallback(L.Callback)` with `__init__(self, output_dir: str, opset_version: int = 17, input_height: int = 224, input_width: int = 224)`
   - `on_train_end`: find EMACallback in `trainer.callbacks` via `isinstance` check; use `ema_cb.ema_state_dict` if found, else `pl_module.state_dict()`
   - Save original state dict, load export weights, call `_export_to_onnx()`, restore original state dict (in try/finally)
   - `_export_to_onnx()`: use legacy exporter path (set `TORCH_ONNX_LEGACY_EXPORTER=1`, monkeypatch `torch.onnx.export` to force `dynamo=False`)
   - `input_names=["input"]`, `output_names=["logits"]`, `opset_version=17`
   - `dynamic_axes={"input": {0: "batch_size"}, "logits": {0: "batch_size"}}`
   - `copy.deepcopy(pl_module).cpu().eval()` for export — do NOT export in-place
   - After ONNX export, also write `labels_mapping.json` sidecar by calling `datamodule.save_labels_mapping()` with `output_dir` path (if datamodule available on trainer)
   - Log file paths and sizes with loguru

4. Create `tests/test_callbacks_ema.py` — port from sibling `test_callbacks_ema.py`:
   - Test EMA state dict is populated after `on_train_batch_end` calls
   - Test EMA weights differ from model weights (decay < 1 means they diverge)
   - Test warmup formula produces correct decay at early steps
   - Test `on_validation_start` swaps EMA weights into model, `on_validation_end` restores original
   - Use a small `nn.Linear` model wrapped in a minimal LightningModule — do NOT use ResNet (too heavy for unit tests)
   - Create a mock trainer with `.callbacks` list containing the EMACallback

5. Create `tests/test_callbacks_onnx_export.py` — adapted from sibling:
   - Test ONNX file is created in output_dir after `on_train_end`
   - Test ONNX model output name is `"logits"` (load with `onnxruntime.InferenceSession`, check `get_outputs()[0].name`)
   - Test ONNX model accepts dynamic batch size (run with batch=1 and batch=2)
   - Test ONNX model output shape is `(batch_size, num_classes)`
   - ALWAYS use `providers=["CPUExecutionProvider"]` for onnxruntime (per MEMORY.md)
   - Test that when EMACallback is present, ONNX export uses EMA weights (verify by checking state dict values differ)
   - Use a minimal model (nn.Linear or small custom model), not ResNet

6. Ensure `pixi run lint` and `pixi run typecheck` pass. Fix any ruff or mypy issues.
  </action>
  <verify>
    `pixi run pytest tests/test_callbacks_ema.py tests/test_callbacks_onnx_export.py -v` passes all tests.
    `pixi run lint` passes.
    `pixi run typecheck` passes.
    `pixi run pytest` passes (all existing tests still pass).
  </verify>
  <done>
    EMACallback correctly maintains EMA state dict and swaps weights for validation. ONNXExportCallback exports from EMA weights with output name "logits" and dynamic batch axis. ONNX model validates under onnxruntime with CPUExecutionProvider. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pixi run python -c "import onnx; import onnxruntime; import matplotlib; print('deps OK')"` succeeds
2. `pixi run pytest tests/test_callbacks_ema.py tests/test_callbacks_onnx_export.py -v` — all tests pass
3. `pixi run pytest` — full suite passes (no regressions)
4. `pixi run lint && pixi run typecheck` — clean
5. Manual check: ONNX export test creates a `.onnx` file, loads it with onnxruntime, output name is "logits"
</verification>

<success_criteria>
- EMACallback updates EMA state dict, swaps weights for validation, restores after
- ONNXExportCallback finds EMA weights from EMACallback and exports with output_names=["logits"]
- ONNX model runs under onnxruntime CPUExecutionProvider with correct output shape
- TrackingWeightedRandomSampler replaces WeightedRandomSampler in datamodule
- All Phase 3 dependencies installed (matplotlib, onnxscript, onnxruntime, pandas)
- All tests pass including existing datamodule tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-callbacks-and-onnx-export/03-01-SUMMARY.md`
</output>
