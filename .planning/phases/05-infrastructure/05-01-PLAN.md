---
phase: 05-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - cloudbuild.yaml
  - scripts/cloud-build.sh
  - scripts/build-docker.sh
  - pixi.toml
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "docker build -f Dockerfile . succeeds locally and produces an image with CUDA 12.1, pixi, and classifier_training installed"
    - "cloudbuild.yaml defines a valid Cloud Build pipeline that builds and pushes tagged images to Artifact Registry"
    - "scripts/cloud-build.sh submits a build to GCP Cloud Build with SHORT_SHA tagging"
    - "scripts/build-docker.sh builds locally with --local flag or pushes to Artifact Registry"
    - "pixi.toml has prod environment and system-requirements.cuda=12.1"
    - "pyproject.toml has [tool.semantic_release] config for version bumps"
  artifacts:
    - path: "Dockerfile"
      provides: "Single-stage Docker image with CUDA 12.1, pixi, classifier_training"
      contains: "nvidia/cuda:12.1"
    - path: "cloudbuild.yaml"
      provides: "GCP Cloud Build pipeline config"
      contains: "classifier-training"
    - path: "scripts/cloud-build.sh"
      provides: "Cloud Build submission script"
      contains: "gcloud builds submit"
    - path: "scripts/build-docker.sh"
      provides: "Local Docker build script"
      contains: "docker build"
    - path: "pixi.toml"
      provides: "prod environment and CUDA system requirement"
      contains: "prod = []"
    - path: "pyproject.toml"
      provides: "Semantic release configuration"
      contains: "tool.semantic_release"
  key_links:
    - from: "Dockerfile"
      to: "pixi.toml"
      via: "pixi install --environment prod"
      pattern: "pixi install --environment prod"
    - from: "cloudbuild.yaml"
      to: "Dockerfile"
      via: "docker build in Cloud Build step"
      pattern: "docker.*build"
    - from: "scripts/cloud-build.sh"
      to: "cloudbuild.yaml"
      via: "--config=cloudbuild.yaml flag"
      pattern: "config=cloudbuild.yaml"
---

<objective>
Create Docker and GCP Cloud Build infrastructure for the classifier-training repo by porting from the sibling object-detection-training repo with name substitutions.

Purpose: Enable containerized training with CUDA 12.1 GPU support and cloud-based image builds via GCP Cloud Build.
Output: Dockerfile, cloudbuild.yaml, cloud-build.sh, build-docker.sh, plus pixi.toml and pyproject.toml updates.
</objective>

<execution_context>
@/Users/ortizeg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ortizeg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pixi.toml and pyproject.toml for infrastructure</name>
  <files>pixi.toml, pyproject.toml</files>
  <action>
**pixi.toml changes:**
1. Add `[system-requirements]` section after `platforms` line:
   ```toml
   [system-requirements]
   cuda = "12.1"
   ```
2. Add `prod = []` to `[environments]` section (after the `default = ["dev"]` line):
   ```toml
   prod = []
   ```
3. Add two task entries to `[tasks]` section:
   ```toml
   build = { cmd = "bash scripts/cloud-build.sh" }
   build-local = { cmd = "bash scripts/build-docker.sh --local" }
   ```

**pyproject.toml changes:**
Add semantic release config block at the end of the file:
```toml
[tool.semantic_release]
version_toml = ["pyproject.toml:project.version"]
build_command = "pip install build && python -m build"

[tool.semantic_release.branches.main]
match = "main"

[tool.semantic_release.branches.develop]
match = "develop"
prerelease = true
prerelease_token = "dev"
```

Reference: sibling repo object-detection-training has identical patterns.
  </action>
  <verify>
Run `pixi run test` to confirm pixi.toml changes don't break existing environment. Grep pixi.toml for `prod = []` and `cuda = "12.1"`. Grep pyproject.toml for `tool.semantic_release`.
  </verify>
  <done>pixi.toml has prod environment, cuda system requirement, build tasks. pyproject.toml has semantic_release config. All existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile and build scripts</name>
  <files>Dockerfile, cloudbuild.yaml, scripts/cloud-build.sh, scripts/build-docker.sh</files>
  <action>
**Dockerfile** — Port from sibling repo with these substitutions:
- Image source label: `https://github.com/ortizeg/classifier-training`
- Dummy init path: `src/classifier_training/__init__.py` (not `src/object_detection_training/__init__.py`)
- Entrypoint: `["pixi", "run", "train"]`
- Keep all other lines identical: `nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04`, `CONDA_OVERRIDE_CUDA=12.1`, `pixi install --environment prod`

**cloudbuild.yaml** — Port from sibling repo with substitutions:
- `_REPO_NAME: classifier-training`
- `_IMAGE_NAME: classifier-training`
- Keep `_REGION: us`, `machineType: 'E2_HIGHCPU_8'`, `timeout: '1800s'`

**scripts/cloud-build.sh** — Port from sibling repo with substitutions:
- `REPO_NAME="classifier-training"`
- `IMAGE_NAME="classifier-training"`
- Keep `REGION="us"`, dry-run flag, uncommitted changes check
- Make executable: `chmod +x scripts/cloud-build.sh`

**scripts/build-docker.sh** — Port from sibling repo with substitutions:
- `IMAGE_NAME="classifier-training"`
- `REPO_NAME="classifier-training"`
- Keep `--local` flag, `--platform linux/amd64`, Artifact Registry push logic
- Make executable: `chmod +x scripts/build-docker.sh`

Create `scripts/` directory if it does not exist.
  </action>
  <verify>
Verify files exist: `ls Dockerfile cloudbuild.yaml scripts/cloud-build.sh scripts/build-docker.sh`. Verify scripts are executable: `test -x scripts/cloud-build.sh && test -x scripts/build-docker.sh`. Grep Dockerfile for `classifier_training`. Grep cloudbuild.yaml for `classifier-training`.
  </verify>
  <done>Dockerfile builds a CUDA 12.1 + pixi image for classifier_training. cloudbuild.yaml defines Cloud Build pipeline for classifier-training. Both shell scripts are executable and reference classifier-training names.</done>
</task>

</tasks>

<verification>
1. `grep -q 'prod = \[\]' pixi.toml` — prod environment exists
2. `grep -q 'cuda = "12.1"' pixi.toml` — CUDA system requirement set
3. `grep -q 'tool.semantic_release' pyproject.toml` — semantic release configured
4. `grep -q 'classifier_training' Dockerfile` — correct package name in Dockerfile
5. `grep -q 'classifier-training' cloudbuild.yaml` — correct image name
6. `test -x scripts/cloud-build.sh` — cloud-build script executable
7. `test -x scripts/build-docker.sh` — build-docker script executable
8. `pixi run test` — all existing 101 tests still pass
</verification>

<success_criteria>
All 4 new files created (Dockerfile, cloudbuild.yaml, scripts/cloud-build.sh, scripts/build-docker.sh). pixi.toml updated with prod env, CUDA req, and build tasks. pyproject.toml updated with semantic_release config. Existing tests unbroken.
</success_criteria>

<output>
After completion, create `.planning/phases/05-infrastructure/05-01-SUMMARY.md`
</output>
